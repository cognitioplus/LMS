<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Paraprofessional Hub | Unified Edition</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://cognitio-plus.appimize.app/assets/apps/user_1097/app_3046/draft/icon/app_logo.png?1765530062">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Supabase Client (This creates a global 'supabase' object) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Use Inter font family -->
    <style>
        :root {
            --primary: #b425aa; /* Deep Magenta */
            --primary-light: #c80ec9;
            --accent: #D4AF37; /* Gold */
            --bg-light: #f5f5f5;
            --supabase-color: #3ecf8e; /* Supabase Green */
            --dark-header: #2d3748; /* Dark Gray for Table Header */
        }
        
        /* Custom Tailwind Configuration */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary)',
                        'primary-light': 'var(--primary-light)',
                        accent: 'var(--accent)',
                        'bg-light': 'var(--bg-light)',
                        supabase: 'var(--supabase-color)',
                        'dark-header': 'var(--dark-header)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
        
        /* Custom Styles for better visual appeal and compelling buttons */
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .section-heading {
            color: var(--primary);
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
        }

        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
        
        #user-id-display {
            font-size: 0.7rem; 
            word-break: break-all; 
            max-width: 150px; 
        }
        @media (max-width: 768px) {
            #user-id-display {
                max-width: 100px;
                font-size: 0.6rem;
            }
        }
        
        .active-nav {
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        /* High-contrast, compelling buttons for the Forum and Hero sections */
        .high-contrast-btn {
            border: 2px solid var(--accent); 
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            /* Added glow/pop effect */
            filter: brightness(1); 
        }
        .high-contrast-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.7); /* Stronger Gold shadow */
            filter: brightness(1.1);
        }

        /* Forum specific button style for CTA */
        .forum-cta-btn {
            background-color: var(--primary);
            color: white;
            font-weight: 700;
        }
        .forum-cta-btn:hover {
            background-color: var(--primary-light);
            box-shadow: 0 6px 10px rgba(180, 37, 170, 0.4);
            transform: translateY(-1px);
        }
        
        /* Modals visibility control */
        #customAlertModal.hidden, #authModal.hidden, #editPostModal.hidden, #addCommentModal.hidden, #editCommentModal.hidden {
            display: none;
        }
        #customAlertModal, #authModal, #editPostModal, #addCommentModal, #editCommentModal {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Supabase Logic & Initialization -->
    <script type="module">
        // --- IMPORTANT: REPLACE THESE WITH YOUR ACTUAL SUPABASE KEYS ---
        // If you are seeing "Invalid API key" errors, please verify these values carefully.
        const SUPABASE_URL ='https://hzzytpbltwdvnmpmmfvl.supabase.co'; 
        const SUPABASE_ANON_KEY ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6enl0cGJsdHdkdm5tcG1tZmZ2bCIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzU5NTYxNDA0LCJleHAiOjIwNzUxMzc0MDR9.RgqO4CThb9NRYUJ8C0DRULytnephMgzW2Zz5E312iI';
        
        // --- Supabase Client Initialization ---
        let supabase = null;
        let isSupabaseConfigured = false;

        // Access the global 'supabase' object created by the standard script tag
        const createClient = window.supabase ? window.supabase.createClient : null;

        if (!createClient) {
             console.error("Supabase client library failed to load! Check the CDN script tag or network.");
             document.getElementById('auth-status').textContent = 'LIBRARY ERROR';
             document.getElementById('user-id-display').textContent = 'Check Supabase CDN!';
        } else if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
             console.error("Supabase configuration missing: SUPABASE_URL or SUPABASE_ANON_KEY is empty.");
             document.getElementById('auth-status').textContent = 'CONFIG ERROR';
             document.getElementById('user-id-display').textContent = 'Update Keys!';
        } else {
             // Initialize client with provided keys.
             supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
             isSupabaseConfigured = true;
             console.log("Supabase client initialized successfully.");
        }
        
        // --- Global State Variables ---
        let userId = null; 
        let personalizedName = 'Guest';
        let isAuthReady = false;
        let listenersInitialized = false;
        let currentPage = 'hub'; 
        let currentPosts = []; 
        let deletionConfirmationId = null;
        let authMode = 'signin'; // 'signin' or 'signup'
        
        // --- Name Generation Utility ---
        const adjectives = ["Wise", "Calm", "Gentle", "Brave", "Kind", "Steady", "Caring", "Focus", "Star", "Gold", "Stellar", "Lunar", "Echo", "Zen"];
        const nouns = ["Mentor", "Guide", "Ally", "Heart", "Anchor", "Fox", "Panda", "Owl", "Wave", "Stone", "Sage", "Bloom", "Hope", "Peace"];

        function generatePersonalizedName(uid) {
            if (!uid) return 'Guest';
            let hash = 0;
            for (let i = 0; i < uid.length; i++) {
                hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            }
            hash = Math.abs(hash);

            const adjIndex = hash % adjectives.length;
            const nounIndex = Math.floor(hash / adjectives.length) % nouns.length;
            
            return `Agent ${adjectives[adjIndex]}-${nouns[nounIndex]}`;
        }


        // --- Supabase Authentication & Initialization ---

        const initializeSupabaseAuth = async () => {
            if (!isSupabaseConfigured) {
                document.getElementById('auth-status').textContent = 'Config Required';
                return;
            }

            try {
                document.getElementById('auth-status').textContent = 'Initializing...';
                
                // Supabase Auth Listener
                supabase.auth.onAuthStateChange((event, session) => {
                    isAuthReady = true;
                    const user = session?.user;

                    if (user) {
                        userId = user.id;
                        personalizedName = generatePersonalizedName(userId);
                        
                        // Update UI with personalized name and actual UID
                        document.getElementById('auth-status').innerHTML = `${personalizedName} <span class="text-xs text-supabase">(Supabase)</span>`;
                        document.getElementById('user-id-display').textContent = `UID: ${userId.substring(0, 12)}...`;
                        document.getElementById('auth-btn-container').innerHTML = `<button onclick="handleSignOut()" class="nav-button px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow" aria-label="Sign out of your account">Sign Out</button>`;
                        
                        if (!listenersInitialized) {
                            initializeSupabaseListeners();
                        }
                        if (currentPage === 'hub') {
                            refreshHubUI(); 
                        }
                    } else {
                        // Logged out
                        userId = null;
                        personalizedName = 'Guest';
                        document.getElementById('auth-status').innerHTML = `Sign In Required`;
                        document.getElementById('user-id-display').textContent = `Status: Logged Out`;
                        document.getElementById('auth-btn-container').innerHTML = `<button onclick="showAuthModalFn('signin')" class="nav-button px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition duration-150 shadow" aria-label="Sign in or register">Sign In</button>`;
                        
                        if (currentPage === 'hub') {
                            renderPosts([]); // Clear posts on sign out
                            refreshHubUI();
                        }
                    }
                });
                
                // Check initial session state manually if listener doesn't fire immediately
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    isAuthReady = true; // Mark as ready even if logged out
                }

            } catch (e) {
                console.error("Supabase initialization failed:", e);
                document.getElementById('auth-status').textContent = 'Auth Init Error';
                document.getElementById('user-id-display').textContent = `ERROR: ${e.message}. Please check SUPABASE_URL.`;
            }
        };
        
        // --- Core Auth Functions ---

        async function handleAuthForm(event) {
            event.preventDefault();
            
            if (!isSupabaseConfigured) {
                alertModal('Configuration error: Supabase keys are missing.', 'error');
                return;
            }
            
            const form = event.target;
            const email = form.email.value;
            const password = form.password.value;
            const submitBtn = document.getElementById('auth-submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = (authMode === 'signin' ? 'Signing In...' : 'Registering...');
            
            try {
                let authResponse;
                if (authMode === 'signin') {
                    authResponse = await supabase.auth.signInWithPassword({ email, password });
                } else {
                    authResponse = await supabase.auth.signUp({ email, password });
                }
                
                if (authResponse.error) {
                    throw authResponse.error;
                }

                alertModal('Authentication successful!', 'success');
                hideAuthModalFn();
            } catch (error) {
                console.error("Auth failed:", error.message || error);
                
                let errorMessage = error.message || 'An unknown error occurred.';
                
                if (errorMessage.includes('Invalid API key')) {
                    errorMessage = "Invalid API Key: Please verify SUPABASE_ANON_KEY in the script block is correct.";
                } else if (errorMessage.includes('Invalid login credentials')) {
                    errorMessage = "Invalid login credentials. Please check your email and password.";
                } else if (errorMessage.includes('Email not confirmed')) {
                     errorMessage = "Email not confirmed. Please check your email inbox for a verification link.";
                }

                alertModal(`Authentication Error: ${errorMessage}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = (authMode === 'signin' ? 'Sign In' : 'Register');
            }
        }
        window.handleAuthForm = handleAuthForm;

        async function handleSignOut() {
            if (!isSupabaseConfigured) return;
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                alertModal('You have been signed out.', 'success');
            } catch (error) {
                console.error("Sign Out failed:", error.message);
                alertModal(`Sign Out Error: ${error.message}`, 'error');
            }
        }
        window.handleSignOut = handleSignOut;
        
        // Modals for Auth, Post, and Comment Management
        
        function showAuthModalFn(mode = 'signin') {
            if (!isSupabaseConfigured) {
                alertModal('Cannot open auth: Supabase keys are missing or invalid.', 'error');
                return;
            }
            authMode = mode;
            document.getElementById('authModal').classList.remove('hidden');
            renderAuthForm();
        }
        window.showAuthModalFn = showAuthModalFn;

        function hideAuthModalFn() {
            document.getElementById('authModal').classList.add('hidden');
        }
        window.hideAuthModalFn = hideAuthModalFn;
        
        function renderAuthForm() {
            const container = document.getElementById('auth-form-container');
            const isSignIn = authMode === 'signin';
            const title = isSignIn ? 'Sign In' : 'Create Account';
            const altText = isSignIn ? 'Need an account? ' : 'Already have an account? ';
            const altAction = isSignIn ? 'Sign Up' : 'Sign In';

            container.innerHTML = `
                <div class="bg-primary p-5 rounded-t-xl">
                    <h3 id="auth-modal-title" class="text-2xl font-bold text-white">${title}</h3>
                </div>
                <form class="p-6" onsubmit="handleAuthForm(event)">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" aria-label="Email Address">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" name="password" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" aria-label="Password">
                    </div>
                    <button type="submit" id="auth-submit-btn" 
                            class="w-full py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md disabled:bg-gray-400">
                        ${title}
                    </button>
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-600">${altText}<button type="button" onclick="showAuthModalFn('${isSignIn ? 'signup' : 'signin'}')" class="text-primary font-semibold hover:underline">${altAction}</button></p>
                    </div>
                    <button type="button" onclick="hideAuthModalFn()" class="mt-4 w-full text-sm text-gray-500 hover:text-gray-700">Cancel</button>
                </form>
            `;
        }


        function showAddCommentModal(postId) {
            if (!userId) { alertModal('Sign in to comment.', 'error'); return; }
            window.currentPostIdForComment = postId;
            document.getElementById('addCommentModal').classList.remove('hidden');
        }
        window.showAddCommentModal = showAddCommentModal;

        function hideAddCommentModal() {
            document.getElementById('add-comment-content').value = '';
            document.getElementById('addCommentModal').classList.add('hidden');
            window.currentPostIdForComment = null;
        }
        window.hideAddCommentModal = hideAddCommentModal;


        // --- Helper Utilities ---
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        function unescapeHtml(str) {
            if (typeof str !== 'string') return '';
            const temp = document.createElement('textarea');
            temp.innerHTML = str;
            return temp.textContent;
        }

        // --- Data Fetching & UI Functions (Supabase) ---

        function refreshHubUI() {
            if (!isAuthReady || currentPage !== 'hub') return;
            updateHubStatus();
            
            const forumSection = document.getElementById('forum-section');
            if (forumSection) {
                 if (userId) {
                    forumSection.classList.remove('hidden');
                 } else {
                    forumSection.classList.add('hidden');
                 }
            }
            renderPosts(currentPosts); 
        }

        // Supabase Realtime Listener setup
        function initializeSupabaseListeners() {
            if (!userId || listenersInitialized || !isSupabaseConfigured) return;
            listenersInitialized = true;
            
            fetchPosts();

            // Realtime listener for the 'discussion_posts' table
            supabase.channel('forum_updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'discussion_posts' }, () => {
                    fetchPosts(); // Re-fetch all data on post change
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, () => {
                    fetchPosts(); // Re-fetch all data on comment change
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log("Supabase Realtime subscription active for forum.");
                    } else if (status === 'TIMED_OUT' || status === 'CHANNEL_ERROR' ) {
                         console.error("Supabase Realtime Channel Error: Check connection and RLS policies.");
                    }
                });
        }
        
        // Modified fetchPosts to include comments
        async function fetchPosts() {
            if (!isSupabaseConfigured) return;
            try {
                // 1. Fetch Posts
                const { data: postsData, error: postsError } = await supabase
                    .from('discussion_posts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (postsError) throw postsError;

                // 2. Fetch Comments (Assuming 'comments' table exists)
                const { data: commentsData, error: commentsError } = await supabase
                    .from('comments')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (commentsError) {
                    console.warn("Could not fetch comments. Assuming 'comments' table or RLS is missing. Continuing without comments.");
                    // Fallback gracefully
                }
                
                const comments = commentsData || [];

                // 3. Structure: Map comments to their respective posts
                const commentsMap = comments.reduce((acc, comment) => {
                    if (!acc[comment.post_id]) {
                        acc[comment.post_id] = [];
                    }
                    acc[comment.post_id].push(comment);
                    return acc;
                }, {});

                const structuredPosts = postsData.map(post => ({
                    ...post,
                    comments: commentsMap[post.id] || []
                }));
                
                currentPosts = structuredPosts;
                renderPosts(currentPosts);

            } catch (error) {
                console.error("Error fetching forum data:", error.message);
                const feedElement = document.getElementById('forum-feed');
                if (feedElement) {
                    feedElement.innerHTML = `<p class="text-center text-red-500 p-8">Error loading forum feed: ${error.message}. Please check RLS rules for 'discussion_posts' and 'comments'.</p>`;
                }
            }
        }
        
        // Renders comments for a single post
        const renderComments = (commentsArray) => {
            if (!commentsArray || commentsArray.length === 0) {
                return '<p class="text-sm text-gray-500 italic mt-3 ml-2">No replies yet. Be the first!</p>';
            }

            let commentsHtml = '';
            commentsArray.forEach(comment => {
                const date = new Date(comment.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const posterId = comment.user_id;
                const posterName = comment.display_name || generatePersonalizedName(posterId); 
                const isOwner = posterId === userId;
                
                const commentManagementButtons = isOwner ? `
                    <div class="flex space-x-2">
                        <button onclick="showEditCommentModal('${comment.id}', '${escapeHtml(comment.content)}')" 
                                class="text-xs text-blue-500 hover:text-blue-700 font-semibold" aria-label="Edit your comment">
                            Edit
                        </button>
                        <button onclick="deleteComment('${comment.id}')" 
                                class="text-xs text-red-500 hover:text-red-700 font-semibold" aria-label="Delete your comment">
                            Delete
                        </button>
                    </div>
                ` : '';

                commentsHtml += `
                    <div id="comment-${comment.id}" class="mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(comment.content)}</p>
                        <div class="mt-1 flex justify-between items-center text-xs text-gray-500">
                            <span class="font-medium">
                                ${posterName} 
                                <span class="text-[10px] text-gray-400">@ ${date}</span>
                            </span>
                            ${commentManagementButtons}
                        </div>
                    </div>
                `;
            });
            return `<div class="mt-4 border-t border-gray-200 pt-3 space-y-2">${commentsHtml}</div>`;
        };

        
        // Renders all posts and calls renderComments for each
        const renderPosts = (postsArray) => {
            const feedElement = document.getElementById('forum-feed');
            if (!feedElement || currentPage !== 'hub') return;
            
            if (!userId) {
                feedElement.innerHTML = `
                    <div class="text-center p-12 bg-white rounded-xl shadow-inner border border-red-200">
                        <p class="text-2xl font-bold text-red-600 mb-4">Forum Locked</p>
                        <p class="text-lg text-gray-600 mb-6">Please <button onclick="showAuthModalFn('signin')" class="text-green-600 font-bold hover:underline" aria-label="Sign in to view the forum">Sign In</button> or <button onclick="showAuthModalFn('signup')" class="text-green-600 font-bold hover:underline" aria-label="Register to view the forum">Register</button> to view and participate in discussions.</p>
                        <button onclick="showAuthModalFn('signin')" class="py-3 px-8 bg-primary text-white font-semibold rounded-lg forum-cta-btn transition duration-150 shadow-xl" aria-label="Sign In Now">
                            Sign In / Register Now
                        </button>
                    </div>
                `;
                return;
            }
            
            if (!isSupabaseConfigured) {
                 feedElement.innerHTML = `<p class="text-center text-red-600 p-8 font-bold">Forum disabled. Supabase configuration is missing or invalid.</p>`;
                 return;
            }


            let postsHtml = '';
            postsArray.forEach(post => {
                const date = new Date(post.created_at).toLocaleString('en-US', { 
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                
                const posterId = post.user_id; 
                const posterName = post.display_name || generatePersonalizedName(posterId);
                const isOwner = posterId === userId;
                
                const managementButtons = isOwner ? `
                    <div class="flex space-x-2 mt-2">
                        <button onclick="showEditPostModal('${post.id}', '${escapeHtml(post.title)}', '${escapeHtml(post.content)}')" 
                                class="text-xs text-blue-600 hover:text-blue-800 font-semibold focus:outline-none" aria-label="Edit your post titled ${escapeHtml(post.title)}">
                            Edit
                        </button>
                        <button onclick="deletePost('${post.id}')" 
                                class="text-xs text-red-600 hover:text-red-800 font-semibold focus:outline-none" aria-label="Delete your post titled ${escapeHtml(post.title)}">
                            Delete
                        </button>
                    </div>
                ` : '';
                
                const commentsContent = renderComments(post.comments);

                postsHtml += `
                    <div id="post-${post.id}" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6 transition hover:shadow-xl">
                        <h4 class="text-2xl font-bold text-gray-900 mb-2">${escapeHtml(post.title)}</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(post.content)}</p>
                        
                        <!-- Post Metadata -->
                        <div class="mt-4 pt-3 border-t border-gray-100 flex flex-col sm:flex-row sm:justify-between sm:items-center text-xs text-gray-500">
                            <span class="pr-4 py-1">
                                Posted by: 
                                <span class="font-bold text-primary">${posterName}</span> 
                                <span class="text-[10px] text-gray-400 break-all">(UID: ${posterId.substring(0, 8)}...)</span>
                            </span>
                            <div class="flex items-center space-x-4">
                                <span>${date}</span>
                                ${managementButtons}
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="mt-4">
                            <h5 class="text-sm font-bold text-gray-800 border-b pb-1">Replies (${post.comments.length})</h5>
                            ${commentsContent}
                            <button onclick="showAddCommentModal('${post.id}')" 
                                    class="mt-3 px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold" aria-label="Add a reply to this post">
                                Add Reply
                            </button>
                        </div>
                    </div>
                `;
            });
            feedElement.innerHTML = postsHtml || '<p class="text-center text-gray-500 p-8">No posts yet. Be the first to start a discussion!</p>';
        };

        // Function to submit a post using Supabase insert
        async function submitPost(event) {
            event.preventDefault();
            if (!isSupabaseConfigured || !userId) { alertModal('Sign in to post.', 'error'); return; }

            const postBtn = document.getElementById('post-submit-btn');
            postBtn.disabled = true;

            const titleInput = document.getElementById('post-title');
            const contentInput = document.getElementById('post-content');
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title || !content) { alertModal('Please fill out both the title and content.', 'error'); postBtn.disabled = false; return; }
            
            try {
                const newPost = {
                    title: title,
                    content: content,
                    user_id: userId,
                    display_name: personalizedName,
                };

                const { error } = await supabase.from('discussion_posts').insert([newPost]);
                if (error) throw error;

                titleInput.value = '';
                contentInput.value = '';
                alertModal('Post submitted successfully!', 'success');

            } catch (error) {
                console.error("Error submitting post:", error.message);
                alertModal(`Failed to submit post: ${error.message}. Check RLS and database schema.`, 'error');
            } finally {
                 postBtn.disabled = false;
            }
        }
        window.submitPost = submitPost;

        // Function to submit a comment using Supabase insert (Assumes 'comments' table)
        async function submitComment(event) {
            event.preventDefault();
            const postId = window.currentPostIdForComment;
            if (!isSupabaseConfigured || !userId || !postId) { alertModal('System or auth error.', 'error'); return; }
            
            const contentInput = document.getElementById('add-comment-content');
            const content = contentInput.value.trim();
            const commentBtn = document.getElementById('add-comment-submit-btn');
            commentBtn.disabled = true;

            if (!content) { alertModal('Comment content cannot be empty.', 'error'); commentBtn.disabled = false; return; }
            
            try {
                const newComment = {
                    post_id: postId,
                    content: content,
                    user_id: userId,
                    display_name: personalizedName,
                };

                const { error } = await supabase.from('comments').insert([newComment]);
                if (error) throw error;

                hideAddCommentModal();
                alertModal('Reply submitted successfully!', 'success');

            } catch (error) {
                console.error("Error submitting comment:", error.message);
                alertModal(`Failed to submit reply: ${error.message}. Check 'comments' table RLS.`, 'error');
            } finally {
                 commentBtn.disabled = false;
            }
        }
        window.submitComment = submitComment;

        
        // --- Post Management (Edit/Delete - Supabase) ---
        
        window.currentEditingPostId = null;

        function showEditPostModal(id, title, content) {
            if (!userId) { alertModal('You must be signed in to edit posts.', 'error'); return; }
            window.currentEditingPostId = id;
            
            document.getElementById('edit-post-title').value = unescapeHtml(title);
            document.getElementById('edit-post-content').value = unescapeHtml(content);
            document.getElementById('editPostModal').classList.remove('hidden');
        }
        window.showEditPostModal = showEditPostModal;
        
        function hideEditPostModal() {
            document.getElementById('editPostModal').classList.add('hidden');
            window.currentEditingPostId = null;
        }
        window.hideEditPostModal = hideEditPostModal;

        async function saveEditedPost(event) {
            event.preventDefault();
            if (!isSupabaseConfigured || !userId) { alertModal('System or auth error.', 'error'); return; }

            const postId = window.currentEditingPostId;
            const title = document.getElementById('edit-post-title').value.trim();
            const content = document.getElementById('edit-post-content').value.trim();
            const editBtn = document.getElementById('edit-post-submit-btn');
            editBtn.disabled = true;

            if (!postId || !title || !content) { alertModal('Data missing.', 'error'); editBtn.disabled = false; return; }

            try {
                const { error } = await supabase
                    .from('discussion_posts')
                    .update({ 
                        title: title, 
                        content: content, 
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', postId);

                if (error) throw error;
                
                alertModal('Post updated successfully!', 'success');
                hideEditPostModal();

            } catch (error) {
                console.error("Error saving edited post:", error.message);
                alertModal(`Failed to update post: ${error.message}. Check RLS permissions.`, 'error');
            } finally {
                editBtn.disabled = false;
            }
        }
        window.saveEditedPost = saveEditedPost;

        async function deletePost(postId) {
            if (!isSupabaseConfigured || !userId) { alertModal('Sign in to delete posts.', 'error'); return; }

            if (deletionConfirmationId !== postId) {
                deletionConfirmationId = postId;
                alertModal("Click 'Delete' again on the same post within 5 seconds to confirm deletion.", 'error');
                setTimeout(() => { if (deletionConfirmationId === postId) deletionConfirmationId = null; }, 5000); 
                return;
            }
            
            deletionConfirmationId = null;

            try {
                // IMPORTANT: You might need to delete associated comments first if you have RLS set up 
                // that prevents deleting a post that has children comments.
                // Assuming RLS allows CASCADE delete or is handled.
                
                const { error: commentDeleteError } = await supabase
                    .from('comments')
                    .delete()
                    .eq('post_id', postId);
                
                if (commentDeleteError) console.warn("Could not delete associated comments:", commentDeleteError.message);

                const { error: postDeleteError } = await supabase
                    .from('discussion_posts')
                    .delete()
                    .eq('id', postId);

                if (postDeleteError) throw postDeleteError;
                
                alertModal('Post deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting post:", error.message);
                alertModal(`Failed to delete post: ${error.message}. Check RLS permissions.`, 'error');
            }
        }
        window.deletePost = deletePost;
        
        // --- Comment Management (Edit/Delete - Supabase) ---
        
        window.currentEditingCommentId = null;

        function showEditCommentModal(id, content) {
            if (!userId) { alertModal('You must be signed in to edit comments.', 'error'); return; }
            window.currentEditingCommentId = id;
            
            document.getElementById('edit-comment-content').value = unescapeHtml(content);
            document.getElementById('editCommentModal').classList.remove('hidden');
        }
        window.showEditCommentModal = showEditCommentModal;
        
        function hideEditCommentModal() {
            document.getElementById('editCommentModal').classList.add('hidden');
            window.currentEditingCommentId = null;
        }
        window.hideEditCommentModal = hideEditCommentModal;

        async function saveEditedComment(event) {
            event.preventDefault();
            if (!isSupabaseConfigured || !userId) { alertModal('System or auth error.', 'error'); return; }

            const commentId = window.currentEditingCommentId;
            const content = document.getElementById('edit-comment-content').value.trim();
            const editBtn = document.getElementById('edit-comment-submit-btn');
            editBtn.disabled = true;

            if (!commentId || !content) { alertModal('Data missing.', 'error'); editBtn.disabled = false; return; }

            try {
                const { error } = await supabase
                    .from('comments')
                    .update({ 
                        content: content, 
                        updated_at: new Date().toISOString() 
                    })
                    .eq('id', commentId);

                if (error) throw error;
                
                alertModal('Reply updated successfully!', 'success');
                hideEditCommentModal();

            } catch (error) {
                console.error("Error saving edited comment:", error.message);
                alertModal(`Failed to update reply: ${error.message}. Check RLS permissions.`, 'error');
            } finally {
                editBtn.disabled = false;
            }
        }
        window.saveEditedComment = saveEditedComment;

        async function deleteComment(commentId) {
            if (!isSupabaseConfigured || !userId) { alertModal('Sign in to delete comments.', 'error'); return; }
            
            // Reusing deletionConfirmationId for confirmation logic
            if (deletionConfirmationId !== commentId) {
                deletionConfirmationId = commentId;
                alertModal("Click 'Delete' again on the same reply within 5 seconds to confirm deletion.", 'error');
                setTimeout(() => { if (deletionConfirmationId === commentId) deletionConfirmationId = null; }, 5000); 
                return;
            }
            
            deletionConfirmationId = null;

            try {
                const { error } = await supabase
                    .from('comments')
                    .delete()
                    .eq('id', commentId);

                if (error) throw error;
                alertModal('Reply deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting comment:", error.message);
                alertModal(`Failed to delete reply: ${error.message}. Check RLS permissions.`, 'error');
            }
        }
        window.deleteComment = deleteComment;
        
        // Custom Modal UI function
        function alertModal(message, type) {
            const modal = document.getElementById('customAlertModal');
            const messageEl = document.getElementById('alertMessage');
            const headerEl = document.getElementById('alertHeader');
            const iconEl = document.getElementById('alertIcon');
            
            if (!modal) return; 

            messageEl.textContent = message;
            
            const headerDiv = modal.querySelector('.modal-content-header');
            headerDiv.classList.remove('bg-primary', 'bg-green-500', 'bg-red-500');

            let headerText = 'Notification';
            let colorClass = 'bg-primary';
            let iconSvg = '';

            if (type === 'success') {
                headerText = 'Success';
                colorClass = 'bg-green-500';
                iconSvg = `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (type === 'error') {
                headerText = 'Error/Warning';
                colorClass = 'bg-red-500';
                iconSvg = `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else {
                colorClass = 'bg-primary';
                iconSvg = `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }

            headerEl.textContent = headerText;
            iconEl.innerHTML = iconSvg;
            headerDiv.classList.add(colorClass);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 3000); 
        }
        window.alertModal = alertModal; 
        
        // Function to simulate updating public hub status (now a mock status)
        async function updateHubStatus() {
            const statusElement = document.getElementById('hub-status-text');

            if (!statusElement || currentPage !== 'hub') return; 

            const activeUsers = Math.floor(Math.random() * 50) + 10;
            const lastCheckInTime = new Date().toLocaleTimeString('en-US', { timeStyle: 'short' });
            
            statusElement.innerHTML = `
                <p class="text-sm font-semibold">Active Peers: <span class="text-primary">${activeUsers}</span></p>
                <p class="text-xs text-gray-500 mt-1">Last Peer Activity: ${lastCheckInTime}</p>
            `;
        }

        /**
         * Sets the current page/view of the application.
         * @param {string} pageKey - The key of the page to navigate to (e.g., 'hub').
         */
        function setPage(pageKey) {
            currentPage = pageKey;
            
            // Only one page ('hub') exists, so we always render the main app
            renderApp(); 
            
            // Update active state of navigation buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active-nav');
                if (btn.getAttribute('data-target') === pageKey) {
                    btn.classList.add('active-nav');
                }
            });
            
            if (pageKey === 'hub') {
                refreshHubUI();
            }
        }
        window.setPage = setPage; // Expose globally for the onload handler

        
        // --- Main App Renderer ---
        
        function renderApp() {
            const container = document.getElementById('app-container');
            if (!container) return;

            // Display configuration error prominently if keys are missing
            const configError = !isSupabaseConfigured ? `
                <div class="max-w-4xl mx-auto mb-8 text-center p-8 bg-red-100 rounded-xl shadow-lg border border-red-500" role="alert">
                    <h3 class="text-2xl font-bold text-red-600 mb-3">Supabase Configuration Required!</h3>
                    <p class="text-gray-700 mb-4">Please update <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code> in the script block to enable authentication and forum functionality. An Invalid API Key error means the keys you provided are incorrect.</p>
                </div>
            ` : '';
            
            const postCreationForm = userId && isSupabaseConfigured ? `
                <!-- Post Creation Form -->
                <form id="post-form" class="bg-white p-6 rounded-xl shadow-lg border border-primary-light/30 mb-8" onsubmit="submitPost(event)" aria-label="Create new discussion thread">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Start a New Discussion Thread as <span class="text-primary">${personalizedName}</span></h3>
                    <input type="text" id="post-title" placeholder="Thread Title (e.g., Question about PFA Step 3)" 
                        class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" required aria-label="Post Title">
                    <textarea id="post-content" rows="4" placeholder="Share your thoughts or ask your question..."
                            class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" required aria-label="Post Content"></textarea>
                    <button type="submit" id="post-submit-btn" 
                            class="w-full py-3 text-white rounded-lg transition duration-150 shadow-lg disabled:bg-gray-400 forum-cta-btn" aria-label="Post to Forum">
                        <span class="text-lg font-extrabold uppercase tracking-wider">Post to Forum</span>
                    </button>
                </form>
            ` : '';

            let content = `
                <!-- Hero Section / Welcome Banner -->
                <section class="mb-12 bg-white shadow-xl rounded-2xl p-6 md:p-12 border border-primary-light/20">
                    <div class="text-center">
                        <p class="text-xl font-semibold text-gray-600 mb-2">Welcome Back,</p>
                        <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight">
                            Your Central Hub for Mental Health and Well-Being Paraprofessional Support
                        </h2>
                        <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-500">
                            Access continuous professional development, essential references, and real-time community support for your practice.
                        </p>
                        <!-- High Contrast Buttons - Centered -->
                        <div class="mt-8 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6">
                            <a href="https://cognitioplus.github.io/CCMHPP/#course-modules" target="_blank"
                               class="inline-block px-8 py-3 bg-accent text-gray-900 font-bold rounded-lg high-contrast-btn transition duration-150 shadow-xl text-lg uppercase tracking-wider hover:text-gray-900"
                               aria-label="Get Started or Continue with Paraprofessional Certification Course">
                                GET STARTED OR CONTINUE WITH PARAPROFESSIONAL CERTIFICATION COURSE
                            </a>
                             <a href="#forum"
                               class="inline-block px-8 py-3 bg-accent text-gray-900 font-bold rounded-lg high-contrast-btn transition duration-150 shadow-xl text-lg uppercase tracking-wider hover:text-gray-900"
                               aria-label="Connect with peers in the community forum">
                                CONNECT WITH PEERS
                            </a>
                        </div>
                    </div>
                </section>

                ${configError}

                <!-- Dashboard Overview: Status & Quick Links -->
                <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    
                    <!-- Community Status (Mocked) -->
                    <div id="community" class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Peers Online Status (Simulated)</h3>
                        <div id="hub-status-text" class="text-gray-700">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Awaiting Auth...
                        </div>
                        <a href="#forum" class="mt-4 block text-xs text-primary-light hover:underline font-medium">Jump to Discussion &rarr;</a>
                    </div>

                    <!-- Quick Link: Module Review -->
                    <a href="https://cognitioplus.github.io/CCMHPP/#course-modules" target="_blank" class="block bg-white p-6 rounded-xl shadow-lg border-l-4 border-accent transition card-hover" aria-label="Access Certification Modules">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Access Certification Modules</h3>
                        <p class="text-gray-500 text-sm">Review PFA, Ethics, and Crisis Response content.</p>
                    </a>

                    <!-- Quick Link: Practicum Log -->
                    <div class="block bg-white p-6 rounded-xl shadow-lg border-l-4 border-gray-400">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Practicum & Supervision</h3>
                        <p class="text-gray-500 text-sm">Log your required support sessions and check mentor feedback.</p>
                        <button class="mt-3 text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-full" aria-label="Simulated Practicum Login">Log In (Simulated)</button>
                    </div>

                </section>
                
                <!-- Community Forum / Discussion Feed -->
                <section id="forum" class="py-12 mb-12 bg-gray-100 rounded-2xl shadow-inner">
                    <div class="px-6 md:px-12">
                        <h2 class="section-heading text-3xl md:text-4xl text-primary">Community Forum</h2>
                        <p class="text-center text-lg text-gray-600 mb-10 max-w-3xl mx-auto">
                            Engage with peers, ask questions, and share resources. Authentication is required to participate.
                        </p>

                        <div id="forum-section" class="max-w-4xl mx-auto" aria-live="polite">
                            ${postCreationForm}

                            <!-- Forum Feed -->
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Latest Threads</h3>
                            <div id="forum-feed" class="space-y-4">
                                <p class="text-center text-gray-500 p-8">Awaiting authentication to load posts...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Core Competencies & Modules -->
                <section id="modules" class="py-12 bg-white rounded-2xl shadow-xl mb-12 border border-gray-200">
                    <div class="px-6 md:px-12">
                        <h2 class="section-heading text-3xl md:text-4xl text-primary">Competency Domains & Course Access</h2>
                        <p class="text-center text-lg text-gray-600 mb-10 max-w-3xl mx-auto">
                            These domains define the standards of practice for mental health and well-being paraprofessionals.
                        </p>
                        
                        <!-- Competency Domains Table -->
                        <div class="max-w-4xl mx-auto overflow-x-auto shadow-2xl rounded-xl mb-10 border border-primary-light/50">
                            <table class="min-w-full divide-y divide-gray-200" role="table">
                                <thead class="bg-dark-header text-white" role="rowgroup">
                                    <tr role="row">
                                        <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider" role="columnheader">
                                            Domain
                                        </th>
                                        <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider" role="columnheader">
                                            Competency Standard
                                        </th>
                                        <th scope="col" class="px-6 py-4 text-left text-sm font-bold uppercase tracking-wider" role="columnheader">
                                            Source
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" role="rowgroup">
                                    <tr class="hover:bg-gray-50 transition duration-150" role="row">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" role="cell">Communication and Support</td>
                                        <td class="px-6 py-4 text-sm text-gray-700" role="cell">Demonstrates empathy, reflective listening, and rapport-building</td>
                                        <td class="px-6 py-4 text-sm text-gray-500" role="cell">WHO mhGAP (2023)</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 transition duration-150" role="row">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" role="cell">Ethics and Confidentiality</td>
                                        <td class="px-6 py-4 text-sm text-gray-700" role="cell">Adheres to data privacy and informed consent practices</td>
                                        <td class="px-6 py-4 text-sm text-gray-500" role="cell">WHO QualityRights, RA 10173</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 transition duration-150" role="row">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" role="cell">Crisis Response and Referral</td>
                                        <td class="px-6 py-4 text-sm text-gray-700" role="cell">Applies LookListenLink in crisis; initiates safe referrals</td>
                                        <td class="px-6 py-4 text-sm text-gray-500" role="cell">WHO PFA Guide</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 transition duration-150" role="row">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" role="cell">Cultural and Community Sensitivity</td>
                                        <td class="px-6 py-4 text-sm text-gray-700" role="cell">Integrates local and cultural contexts</td>
                                        <td class="px-6 py-4 text-sm text-gray-500" role="cell">PCMH Framework</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50 transition duration-150" role="row">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" role="cell">Personal and Peer Resilience</td>
                                        <td class="px-6 py-4 text-sm text-gray-700" role="cell">Practices mindfulness, self-care, and supervision</td>
                                        <td class="px-6 py-4 text-sm text-gray-500" role="cell">DOHPCMH Workforce Pillar</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Course Access Button (Duplicated from Hero as requested) -->
                        <div class="text-center mt-10">
                            <a href="https://cognitioplus.github.io/CCMHPP/#course-modules" target="_blank"
                               class="inline-block px-8 py-3 bg-primary text-white font-bold rounded-lg hover:bg-primary-light transition duration-150 shadow-xl text-lg uppercase tracking-wider">
                                GET STARTED OR CONTINUE THE PARAPROFESSIONAL CERTIFICATION COURSE
                            </a>
                        </div>

                    </div>
                </section>

                <!-- Knowledge Base & Required References (Updated Links) -->
                <section id="resources" class="py-12 mb-12">
                    <div class="px-6 md:px-12">
                        <h2 class="section-heading text-3xl md:text-4xl">Knowledge Base & References</h2>
                        <p class="text-center text-lg text-gray-600 mb-10 max-w-3xl mx-auto">
                            Access the core documents, frameworks, and legal references that govern your practice.
                        </p>
                        
                        <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                            <ul class="space-y-4">
                                <!-- Reference list items with active hyperlinks -->
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">1.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">World Health Organization (2023). mhGAP Intervention Guide: Version 3.0</p>
                                        <a href="https://iris.who.int/server/api/core/bitstreams/93e56376-0e64-4a08-bdd0-703313be5354/content" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="View mhGAP Intervention Guide Source (opens in new tab)">&rarr; View Source (WHO)</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">2.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">World Health Organization (2022). QualityRights Mental Health, Disability and Human Rights Toolkit</p>
                                        <a href="https://iris.who.int/server/api/core/bitstreams/204df45f-b453-4e86-8954-ca8e6f99fc45/content" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="View QualityRights Toolkit Source (opens in new tab)">&rarr; View Source (WHO)</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">3.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">Philippine Mental Health Act (Republic Act 11036)</p>
                                        <a href="https://elibrary.judiciary.gov.ph/thebookshelf/showdocs/2/83255" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="View Philippine Mental Health Act Law (opens in new tab)">&rarr; View Law</a>
                                    </div>
                                </li>
                                 <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">4.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">Data Privacy Act (Republic Act 10173) of 2012</p>
                                        <a href="https://privacy.gov.ph/data-privacy-act/" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="View Data Privacy Act Law (opens in new tab)">&rarr; View Law</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">5.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">DOH Guidelines on Community-Based Mental Health Services (2021)</p>
                                        <a href="https://iris.who.int/server/api/core/bitstreams/184ff4ef-9c4c-4aad-b1c5-437b08bc0184/content" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="View DOH Guidelines (opens in new tab)">&rarr; View Guidelines</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">6.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">Cognitio+ Comprehensive Guidebook for Paraprofessional</p>
                                        <a href="https://cognitioplus.aiwaapp.live/guidebook" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="Open Guidebook (opens in new tab)">&rarr; Open Guidebook</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">7.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">Cognitio+ Mental Health Certification Course Manual</p>
                                        <a href="https://cognitioplus.aiwaapp.live/paraprofessional-course-manual" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="Open Course Manual (opens in new tab)">&rarr; Open Course Manual</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">8.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">Cognitio+'s Web App (Service Access)</p>
                                        <a href="https://cognitio-plus.com" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="Access Cognitio+ Web App (opens in new tab)">&rarr; Access Web App</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">9.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">Cognitio+'s Digital Resilience Tools</p>
                                        <a href="https://cognitio-plus.appimize.app/solutions" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="Access Digital Resilience Tools (opens in new tab)">&rarr; Access Tools</a>
                                    </div>
                                </li>
                                <li class="flex items-start space-x-3" role="listitem">
                                    <span class="text-accent font-bold pt-1">10.</span>
                                    <div>
                                        <p class="font-medium text-gray-800">Cognitio+'s Tele-therapy and Online Counseling Services</p>
                                        <a href="https://cognitio-plus.appimize.app/online-counseling" target="_blank" class="text-sm text-primary hover:text-primary-light transition hover:underline" aria-label="Access Counseling Services (opens in new tab)">&rarr; Access Counseling</a>
                                    </div>
                                </li>
                            </ul>
                            
                            <div class="text-center mt-10 border-t pt-6">
                                <p class="mb-4 text-gray-700 font-medium">Quick Access: Certification Course</p>
                                <a href="https://cognitioplus.aiwaapp.live/paraprofessional-course" target="_blank"
                                   class="inline-block px-6 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-primary-light transition duration-150 shadow-md">
                                    Access Mental Health Certification Course
                                </a>
                            </div>

                            <!-- INVITE and SHARE Buttons -->
                            <div class="text-center mt-12 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6">
                                <a href="https://twitter.com/intent/tweet?text=Join%20me%20at%20the%20Paraprofessional%20Hub!%20It's%20a%20great%20resource%20for%20mental%20health%20support." target="_blank"
                                   class="inline-block px-8 py-3 bg-accent text-gray-900 font-bold rounded-lg high-contrast-btn transition duration-150 shadow-xl text-lg uppercase tracking-wider"
                                   aria-label="Share this hub on social media">
                                    SHARE HUB
                                </a>
                                <button onclick="alertModal('You can share the current URL with your colleagues to invite them!', 'success')"
                                   class="inline-block px-8 py-3 bg-accent text-gray-900 font-bold rounded-lg high-contrast-btn transition duration-150 shadow-xl text-lg uppercase tracking-wider"
                                   aria-label="Invite a colleague to the hub">
                                    INVITE COLLEAGUE
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            `;

            container.innerHTML = content;
        }

        window.onload = () => {
            initializeSupabaseAuth();
            setPage(currentPage); // Now setPage is defined and accessible
        };
    </script>

    <!-- Header & Navigation -->
    <header class="sticky top-0 bg-white shadow-lg z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo & Title -->
            <div class="flex items-center space-x-3">
                <img
                    src="https://cognitio-plus.appimize.app/assets/apps/user_1097/app_3046/draft/icon/app_logo.png?1765530062"
                    alt="Cognitio+ Logo"
                    class="h-10 w-10 rounded-full shadow-md"
                    aria-label="Cognitio Plus Logo"
                />
                <h1 class="text-2xl font-bold text-primary">Paraprofessional Hub</h1>
            </div>
            
            <!-- User Status & Action Buttons -->
            <div class="flex items-center space-x-4 text-sm">
                
                <!-- Navigation Buttons (Only Hub remains) -->
                <button data-target="hub" onclick="setPage('hub')" 
                        class="nav-button active-nav px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-primary-light transition duration-150 shadow" aria-current="page">
                    Hub & Forum
                </button>
                
                <!-- Auth Button Container -->
                <div id="auth-btn-container">
                    <button onclick="showAuthModalFn('signin')" class="nav-button px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition duration-150 shadow" aria-label="Sign in or register">Sign In</button>
                </div>
                
                <div class="hidden md:block text-right">
                    <!-- Personalized Name Display -->
                    <p id="auth-status" class="font-medium text-gray-700">Initializing...</p>
                    <!-- Actual UID Display -->
                    <p id="user-id-display" class="text-xs text-gray-500 max-w-full truncate">Awaiting Auth...</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Container (Controlled by JS Router) -->
    <main class="pt-8">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div id="app-container">
                <!-- Content will be rendered here by renderApp() -->
                <p class="text-center text-gray-600 py-12">Starting up application and authenticating...</p>
            </div>
        </div>
    </main>
            </p>
        </div>
    
    <!-- Custom Alert Modal Structure -->
    <div id="customAlertModal" class="fixed inset-0 z-[100] hidden items-center justify-center pointer-events-none" role="alert" aria-live="assertive" aria-modal="true">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden max-w-sm w-full m-4 transform transition-all duration-300 ease-out translate-y-0 opacity-100">
            <div class="modal-content-header bg-primary p-4 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div id="alertIcon"></div>
                    <h4 id="alertHeader" class="text-white font-bold">Notification</h4>
                </div>
            </div>
            <div class="p-4">
                <p id="alertMessage" class="text-gray-700"></p>
            </div>
        </div>
    </div>
    
    <!-- Authentication Modal (Sign In / Sign Up) -->
    <div id="authModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-[100] flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
        <div id="auth-form-container" class="bg-white rounded-xl shadow-2xl max-w-sm w-full m-4" role="document">
            <!-- Form content will be rendered here by renderAuthForm() -->
        </div>
    </div>

    <!-- Post Edit Modal Structure -->
    <div id="editPostModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-[100] flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="edit-post-title-header">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full m-4" role="document">
            <div class="bg-primary p-4 rounded-t-xl">
                <h3 id="edit-post-title-header" class="text-xl font-bold text-white">Edit Discussion Post</h3>
            </div>
            <form class="p-6" onsubmit="saveEditedPost(event)">
                <div class="mb-4">
                    <label for="edit-post-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="edit-post-title" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" aria-label="Edit Post Title">
                </div>
                <div class="mb-6">
                    <label for="edit-post-content" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                    <textarea id="edit-post-content" rows="6" required 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" aria-label="Edit Post Content"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideEditPostModal()" 
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                        Cancel
                    </button>
                    <button type="submit" id="edit-post-submit-btn" 
                            class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition disabled:bg-gray-400">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Comment Modal Structure -->
    <div id="addCommentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-[100] flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="add-comment-title-header">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full m-4" role="document">
            <div class="bg-primary p-4 rounded-t-xl">
                <h3 id="add-comment-title-header" class="text-xl font-bold text-white">Add a Reply</h3>
            </div>
            <form class="p-6" onsubmit="submitComment(event)">
                <div class="mb-6">
                    <label for="add-comment-content" class="block text-sm font-medium text-gray-700 mb-1">Your Reply</label>
                    <textarea id="add-comment-content" rows="4" required 
                              placeholder="Type your reply here..."
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" aria-label="Reply Content"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideAddCommentModal()" 
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                        Cancel
                    </button>
                    <button type="submit" id="add-comment-submit-btn" 
                            class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition disabled:bg-gray-400">
                        Submit Reply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Comment Modal Structure -->
    <div id="editCommentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-[100] flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="edit-comment-title-header">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full m-4" role="document">
            <div class="bg-primary p-4 rounded-t-xl">
                <h3 id="edit-comment-title-header" class="text-xl font-bold text-white">Edit Reply</h3>
            </div>
            <form class="p-6" onsubmit="saveEditedComment(event)">
                <div class="mb-6">
                    <label for="edit-comment-content" class="block text-sm font-medium text-gray-700 mb-1">Reply Content</label>
                    <textarea id="edit-comment-content" rows="4" required 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition" aria-label="Edit Reply Content"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideEditCommentModal()" 
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                        Cancel
                    </button>
                    <button type="submit" id="edit-comment-submit-btn" 
                            class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition disabled:bg-gray-400">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
